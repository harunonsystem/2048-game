name: Deploy to Preview

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    # PRがオープン状態の場合のみ実行（マージ後のrebaseによる再デプロイを防止）
    if: github.event.pull_request.state == 'open'
    permissions:
      contents: read
      actions: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js and Dependencies
        uses: ./.github/actions/setup-node-deps

      - name: Test and Build
        uses: ./.github/actions/test-and-build
        with:
          run-e2e: "true"

      - name: Load development secrets
        id: load-secrets
        uses: ./.github/actions/load-1password-secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Prepare Preview Deploy
        id: prepare
        uses: harunonsystem/cf-workers-actions/prepare-preview-deploy@185b45ca868f70d3dcffdb0960f945fe4c27b1bf # v1.1.0
        with:
          worker-name: '2048-game-pr-${{ github.event.pull_request.number }}'
          domain: 'harunonsystem.workers.dev'
          environment: 'preview'

      - name: Deploy with Wrangler
        id: deploy
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          apiToken: ${{ steps.load-secrets.outputs.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ steps.load-secrets.outputs.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env preview

      - name: Comment PR
        uses: harunonsystem/cf-workers-actions/pr-comment@185b45ca868f70d3dcffdb0960f945fe4c27b1bf # v1.1.0
        with:
          deployment-url: ${{ steps.prepare.outputs.deployment-url }}
          deployment-success: ${{ steps.deploy.outcome == 'success' }}
          deployment-name: ${{ steps.prepare.outputs.deployment-name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
